BEGIN;
BEGIN
SET client_min_messages TO NOTICE;
SET
SET search_path TO 'example2', 'public';
SET
UPDATE vehicles
    SET stops = NULL;
UPDATE 180
SELECT id
FROM shipments
WHERE '2019-12-09 14:00:00' <= p_tw_open AND d_tw_close <= '2019-12-09 15:55:00'
ORDER BY id;
 id
-----
  20
  50
  67
  93
  97
 105
 205
 219
 229
 406
 407
 425
 429
 432
 472
 476
 503
 505
 506
 507
 508
(21 rows)

SELECT id, stops
FROM vehicles
WHERE id IN (585);
 id  | stops
-----+-------
 585 |
(1 row)

SELECT *
FROM vrp_pickDeliverAdd(
  $$
    SELECT id, amount, p_id, p_tw_open, p_tw_close, p_t_service, d_id, d_tw_open, d_tw_close, d_t_service
    FROM shipments
  $$,
  $$
    SELECT id, capacity, s_id, s_tw_open, s_tw_close, s_t_service, e_t_service, stops
    FROM vehicles WHERE id = 585
  $$,
  $$SELECT start_vid, end_vid, travel_time FROM timeMatrix$$,
  $$SELECT * FROM tdm('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
  507, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | shipment_id | load |  travel  |       arrival       | waiting_time |      schedule       | service  |      departure      | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+-------------+------+----------+---------------------+--------------+---------------------+----------+---------------------+-------+--------
   1 |           1 |         -1 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 1970-01-01 00:00:00 | 00:00:00     | 1970-01-01 00:00:00 | 00:00:00 | 1970-01-01 00:00:00 |     0 |      0
   2 |           1 |         -1 |        2 |         4 | 3619121402769 |          -1 |    0 | 00:00:00 | 1970-01-01 00:00:00 | 00:00:00     | 1970-01-01 00:00:00 | 00:00:00 | 1970-01-01 00:00:00 |     0 |      0
   3 |           2 |        585 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 2019-12-09 14:00:00 | 00:00:00     | 2019-12-09 14:00:00 | 00:00:00 | 2019-12-09 14:00:00 |     0 |      0
   4 |           2 |        585 |        2 |         2 | 3618671402855 |         507 |    1 | 00:04:21 | 2019-12-09 14:04:21 | 00:00:00     | 2019-12-09 14:04:21 | 00:00:00 | 2019-12-09 14:04:21 |     0 |      0
   5 |           2 |        585 |        3 |         3 | 3619091402880 |         507 |    0 | 00:03:19 | 2019-12-09 14:07:40 | 00:00:00     | 2019-12-09 14:07:40 | 00:00:00 | 2019-12-09 14:07:40 |     0 |      0
   6 |           2 |        585 |        4 |         4 | 3619121402769 |          -1 |    0 | 00:05:16 | 2019-12-09 14:12:56 | 00:00:00     | 2019-12-09 14:12:56 | 00:00:00 | 2019-12-09 14:12:56 |     0 |      0
   7 |          -2 |          0 |        0 |           |            -1 |          -1 |   -1 | 00:12:56 | 1969-12-31 23:59:59 | 00:00:00     | 1969-12-31 23:59:59 | 00:00:00 | 1970-01-01 00:12:56 |     0 |      0
(7 rows)

UPDATE vehicles SET stops = ARRAY[507, 507]
WHERE id = 585;
UPDATE 1
SELECT *
FROM vrp_pickDeliverAdd(
  $$SELECT * FROM shipments$$::TEXT,
  $$SELECT * FROM vehicles WHERE id = 585$$::TEXT,
  $$SELECT start_vid, end_vid, travel_time FROM timeMatrix$$,
  $$SELECT * FROM tdm('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
  205, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | shipment_id | load |  travel  |       arrival       | waiting_time |      schedule       | service  |      departure      | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+-------------+------+----------+---------------------+--------------+---------------------+----------+---------------------+-------+--------
   1 |           1 |         -1 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 1970-01-01 00:00:00 | 00:00:00     | 1970-01-01 00:00:00 | 00:00:00 | 1970-01-01 00:00:00 |     0 |      0
   2 |           1 |         -1 |        2 |         4 | 3619121402769 |          -1 |    0 | 00:00:00 | 1970-01-01 00:00:00 | 00:00:00     | 1970-01-01 00:00:00 | 00:00:00 | 1970-01-01 00:00:00 |     0 |      0
   3 |           2 |        585 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 2019-12-09 14:00:00 | 00:00:00     | 2019-12-09 14:00:00 | 00:00:00 | 2019-12-09 14:00:00 |     0 |      0
   4 |           2 |        585 |        2 |         2 | 3618671402855 |         507 |    1 | 00:04:21 | 2019-12-09 14:04:21 | 00:00:00     | 2019-12-09 14:04:21 | 00:00:00 | 2019-12-09 14:04:21 |     0 |      0
   5 |           2 |        585 |        3 |         3 | 3619091402880 |         507 |    0 | 00:03:19 | 2019-12-09 14:07:40 | 00:00:00     | 2019-12-09 14:07:40 | 00:00:00 | 2019-12-09 14:07:40 |     0 |      0
   6 |           2 |        585 |        4 |         2 | 3620261402709 |         205 |    1 | 00:08:57 | 2019-12-09 14:16:37 | 00:43:23     | 2019-12-09 15:00:00 | 00:00:00 | 2019-12-09 15:00:00 |     0 |      0
   7 |           2 |        585 |        5 |         3 | 3620351402932 |         205 |    0 | 00:09:15 | 2019-12-09 15:09:15 | 00:00:00     | 2019-12-09 15:09:15 | 00:00:00 | 2019-12-09 15:09:15 |     0 |      0
   8 |           2 |        585 |        6 |         4 | 3619121402769 |          -1 |    0 | 00:06:52 | 2019-12-09 15:16:07 | 00:00:00     | 2019-12-09 15:16:07 | 00:00:00 | 2019-12-09 15:16:07 |     0 |      0
   9 |          -2 |          0 |        0 |           |            -1 |          -1 |   -1 | 00:32:44 | 1969-12-31 23:59:59 | 00:43:23     | 1969-12-31 23:59:59 | 00:00:00 | 1970-01-01 01:16:07 |     0 |      0
(9 rows)

UPDATE vehicles SET stops = ARRAY[507, 507, 205, 205]
WHERE id = 585;
UPDATE 1
SELECT *
FROM vrp_pickDeliverAdd(
  $$SELECT * FROM shipments$$::TEXT,
  $$SELECT * FROM vehicles WHERE id = 585$$::TEXT,
  $$SELECT start_vid, end_vid, travel_time FROM timeMatrix$$,
  $$SELECT * FROM tdm('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
  508, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | shipment_id | load |  travel  |       arrival       | waiting_time |      schedule       | service  |      departure      | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+-------------+------+----------+---------------------+--------------+---------------------+----------+---------------------+-------+--------
   1 |           1 |         -1 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 1970-01-01 00:00:00 | 00:00:00     | 1970-01-01 00:00:00 | 00:00:00 | 1970-01-01 00:00:00 |     0 |      0
   2 |           1 |         -1 |        2 |         4 | 3619121402769 |          -1 |    0 | 00:00:00 | 1970-01-01 00:00:00 | 00:00:00     | 1970-01-01 00:00:00 | 00:00:00 | 1970-01-01 00:00:00 |     0 |      0
   3 |           2 |        585 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 2019-12-09 14:00:00 | 00:00:00     | 2019-12-09 14:00:00 | 00:00:00 | 2019-12-09 14:00:00 |     0 |      0
   4 |           2 |        585 |        2 |         2 | 3618671402855 |         507 |    1 | 00:04:21 | 2019-12-09 14:04:21 | 00:00:00     | 2019-12-09 14:04:21 | 00:00:00 | 2019-12-09 14:04:21 |     0 |      0
   5 |           2 |        585 |        3 |         2 | 3618791402920 |         508 |    2 | 00:02:31 | 2019-12-09 14:06:52 | 00:00:00     | 2019-12-09 14:06:52 | 00:00:00 | 2019-12-09 14:06:52 |     0 |      0
   6 |           2 |        585 |        4 |         3 | 3619091402880 |         507 |    1 | 00:03:06 | 2019-12-09 14:09:58 | 00:00:00     | 2019-12-09 14:09:58 | 00:00:00 | 2019-12-09 14:09:58 |     0 |      0
   7 |           2 |        585 |        5 |         3 | 3619401402840 |         508 |    0 | 00:03:18 | 2019-12-09 14:13:16 | 00:00:00     | 2019-12-09 14:13:16 | 00:00:00 | 2019-12-09 14:13:16 |     0 |      0
   8 |           2 |        585 |        6 |         2 | 3620261402709 |         205 |    1 | 00:07:38 | 2019-12-09 14:20:54 | 00:39:06     | 2019-12-09 15:00:00 | 00:00:00 | 2019-12-09 15:00:00 |     0 |      0
   9 |           2 |        585 |        7 |         3 | 3620351402932 |         205 |    0 | 00:09:15 | 2019-12-09 15:09:15 | 00:00:00     | 2019-12-09 15:09:15 | 00:00:00 | 2019-12-09 15:09:15 |     0 |      0
  10 |           2 |        585 |        8 |         4 | 3619121402769 |          -1 |    0 | 00:06:52 | 2019-12-09 15:16:07 | 00:00:00     | 2019-12-09 15:16:07 | 00:00:00 | 2019-12-09 15:16:07 |     0 |      0
  11 |          -2 |          0 |        0 |           |            -1 |          -1 |   -1 | 00:37:01 | 1969-12-31 23:59:59 | 00:39:06     | 1969-12-31 23:59:59 | 00:00:00 | 1970-01-01 01:16:07 |     0 |      0
(11 rows)

UPDATE vehicles SET stops = ARRAY[507, 508, 507, 508, 205, 205]
WHERE id = 585;
UPDATE 1
SELECT *
FROM vrp_pickDeliverAdd(
  $$SELECT * FROM shipments$$::TEXT,
  $$SELECT * FROM vehicles WHERE id = 585$$::TEXT,
  $$SELECT start_vid, end_vid, travel_time FROM timeMatrix$$,
  $$SELECT * FROM tdm('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
  20, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | shipment_id | load |  travel  |       arrival       | waiting_time |      schedule       | service  |      departure      | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+-------------+------+----------+---------------------+--------------+---------------------+----------+---------------------+-------+--------
   1 |           1 |        585 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 2019-12-09 14:00:00 | 00:00:00     | 2019-12-09 14:00:00 | 00:00:00 | 2019-12-09 14:00:00 |     0 |      0
   2 |           1 |        585 |        2 |         2 | 3618671402855 |         507 |    1 | 00:04:21 | 2019-12-09 14:04:21 | 00:00:00     | 2019-12-09 14:04:21 | 00:00:00 | 2019-12-09 14:04:21 |     0 |      0
   3 |           1 |        585 |        3 |         2 | 3618791402920 |         508 |    2 | 00:02:31 | 2019-12-09 14:06:52 | 00:00:00     | 2019-12-09 14:06:52 | 00:00:00 | 2019-12-09 14:06:52 |     0 |      0
   4 |           1 |        585 |        4 |         3 | 3619091402880 |         507 |    1 | 00:03:06 | 2019-12-09 14:09:58 | 00:00:00     | 2019-12-09 14:09:58 | 00:00:00 | 2019-12-09 14:09:58 |     0 |      0
   5 |           1 |        585 |        5 |         3 | 3619401402840 |         508 |    0 | 00:03:18 | 2019-12-09 14:13:16 | 00:00:00     | 2019-12-09 14:13:16 | 00:00:00 | 2019-12-09 14:13:16 |     0 |      0
   6 |           1 |        585 |        6 |         2 | 3620261402709 |         205 |    1 | 00:07:38 | 2019-12-09 14:20:54 | 00:39:06     | 2019-12-09 15:00:00 | 00:00:00 | 2019-12-09 15:00:00 |     0 |      0
   7 |           1 |        585 |        7 |         3 | 3620351402932 |         205 |    0 | 00:09:15 | 2019-12-09 15:09:15 | 00:00:00     | 2019-12-09 15:09:15 | 00:00:00 | 2019-12-09 15:09:15 |     0 |      0
   8 |           1 |        585 |        8 |         4 | 3619121402769 |          -1 |    0 | 00:06:52 | 2019-12-09 15:16:07 | 00:00:00     | 2019-12-09 15:16:07 | 00:00:00 | 2019-12-09 15:16:07 |     0 |      0
   9 |           2 |         -1 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 1970-01-01 00:00:00 | 437750:39:51 | 1970-01-01 00:00:00 | 00:00:00 | 2019-12-09 14:39:51 |     0 |      0
  10 |           2 |         -1 |        2 |         2 | 3627141402002 |          20 |    1 | 00:20:09 | 2019-12-09 15:00:00 | 00:00:00     | 2019-12-09 15:00:00 | 00:00:00 | 2019-12-09 15:00:00 |     0 |      0
  11 |           2 |         -1 |        3 |         3 | 3629411402032 |          20 |    0 | 00:07:52 | 2019-12-09 15:07:52 | 00:00:00     | 2019-12-09 15:07:52 | 00:00:00 | 2019-12-09 15:07:52 |     0 |      0
  12 |           2 |         -1 |        4 |         4 | 3619121402769 |          -1 |    0 | 00:27:03 | 2019-12-09 15:34:55 | 00:00:00     | 2019-12-09 15:34:55 | 00:00:00 | 2019-12-09 15:34:55 |     0 |      0
  13 |          -2 |          0 |        0 |           |            -1 |          -1 |   -1 | 00:37:01 | 1969-12-31 23:59:59 | 00:39:06     | 1969-12-31 23:59:59 | 00:00:00 | 1970-01-01 01:16:07 |     0 |      0
(13 rows)

SELECT *
FROM vrp_pickDeliverAdd(
  $$SELECT * FROM shipments$$::TEXT,
  $$SELECT * FROM vehicles$$::TEXT,
  $$SELECT start_vid, end_vid, travel_time FROM timeMatrix$$,
  $$SELECT * FROM tdm('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
  20, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | shipment_id | load |  travel  |       arrival       | waiting_time |      schedule       | service  |      departure      | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+-------------+------+----------+---------------------+--------------+---------------------+----------+---------------------+-------+--------
   1 |           1 |         -1 |        1 |         1 | 3624551401919 |          -1 |    0 | 00:00:00 | 1970-01-01 00:00:00 | 00:00:00     | 1970-01-01 00:00:00 | 00:00:00 | 1970-01-01 00:00:00 |     0 |      0
   2 |           1 |         -1 |        2 |         4 | 3624551401919 |          -1 |    0 | 00:00:00 | 1970-01-01 00:00:00 | 00:00:00     | 1970-01-01 00:00:00 | 00:00:00 | 1970-01-01 00:00:00 |     0 |      0
   3 |           2 |        589 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 2019-12-09 13:50:00 | 00:00:00     | 2019-12-09 13:50:00 | 00:00:00 | 2019-12-09 13:50:00 |     0 |      0
   4 |           2 |        589 |        2 |         4 | 3619121402769 |          -1 |    0 | 00:00:00 | 2019-12-09 13:50:00 | 00:00:00     | 2019-12-09 13:50:00 | 00:00:00 | 2019-12-09 13:50:00 |     0 |      0
   5 |           3 |        597 |        1 |         1 | 3624551401919 |          -1 |    0 | 00:00:00 | 2019-12-09 14:00:00 | 00:52:38     | 2019-12-09 14:00:00 | 00:00:00 | 2019-12-09 14:52:38 |     0 |      0
   6 |           3 |        597 |        2 |         2 | 3627141402002 |          20 |    1 | 00:07:22 | 2019-12-09 15:00:00 | 00:00:00     | 2019-12-09 15:00:00 | 00:00:00 | 2019-12-09 15:00:00 |     0 |      0
   7 |           3 |        597 |        3 |         3 | 3629411402032 |          20 |    0 | 00:07:52 | 2019-12-09 15:07:52 | 00:00:00     | 2019-12-09 15:07:52 | 00:00:00 | 2019-12-09 15:07:52 |     0 |      0
   8 |           3 |        597 |        4 |         4 | 3624551401919 |          -1 |    0 | 00:11:37 | 2019-12-09 15:19:29 | 00:00:00     | 2019-12-09 15:19:29 | 00:00:00 | 2019-12-09 15:19:29 |     0 |      0
   9 |           4 |        601 |        1 |         1 | 3624551401919 |          -1 |    0 | 00:00:00 | 2019-12-09 13:00:00 | 00:00:00     | 2019-12-09 13:00:00 | 00:00:00 | 2019-12-09 13:00:00 |     0 |      0
  10 |           4 |        601 |        2 |         4 | 3624551401919 |          -1 |    0 | 00:00:00 | 2019-12-09 13:00:00 | 00:00:00     | 2019-12-09 13:00:00 | 00:00:00 | 2019-12-09 13:00:00 |     0 |      0
  11 |           5 |        605 |        1 |         1 | 3624551401919 |          -1 |    0 | 00:00:00 | 2019-12-09 14:00:00 | 00:00:00     | 2019-12-09 14:00:00 | 00:00:00 | 2019-12-09 14:00:00 |     0 |      0
  12 |           5 |        605 |        2 |         4 | 3624551401919 |          -1 |    0 | 00:00:00 | 2019-12-09 14:00:00 | 00:00:00     | 2019-12-09 14:00:00 | 00:00:00 | 2019-12-09 14:00:00 |     0 |      0
  13 |           6 |        585 |        1 |         1 | 3619121402769 |          -1 |    0 | 00:00:00 | 2019-12-09 14:00:00 | 00:00:00     | 2019-12-09 14:00:00 | 00:00:00 | 2019-12-09 14:00:00 |     0 |      0
  14 |           6 |        585 |        2 |         2 | 3618671402855 |         507 |    1 | 00:04:21 | 2019-12-09 14:04:21 | 00:00:00     | 2019-12-09 14:04:21 | 00:00:00 | 2019-12-09 14:04:21 |     0 |      0
  15 |           6 |        585 |        3 |         2 | 3618791402920 |         508 |    2 | 00:02:31 | 2019-12-09 14:06:52 | 00:00:00     | 2019-12-09 14:06:52 | 00:00:00 | 2019-12-09 14:06:52 |     0 |      0
  16 |           6 |        585 |        4 |         3 | 3619091402880 |         507 |    1 | 00:03:06 | 2019-12-09 14:09:58 | 00:00:00     | 2019-12-09 14:09:58 | 00:00:00 | 2019-12-09 14:09:58 |     0 |      0
  17 |           6 |        585 |        5 |         3 | 3619401402840 |         508 |    0 | 00:03:18 | 2019-12-09 14:13:16 | 00:00:00     | 2019-12-09 14:13:16 | 00:00:00 | 2019-12-09 14:13:16 |     0 |      0
  18 |           6 |        585 |        6 |         2 | 3620261402709 |         205 |    1 | 00:07:38 | 2019-12-09 14:20:54 | 00:39:06     | 2019-12-09 15:00:00 | 00:00:00 | 2019-12-09 15:00:00 |     0 |      0
  19 |           6 |        585 |        7 |         3 | 3620351402932 |         205 |    0 | 00:09:15 | 2019-12-09 15:09:15 | 00:00:00     | 2019-12-09 15:09:15 | 00:00:00 | 2019-12-09 15:09:15 |     0 |      0
  20 |           6 |        585 |        8 |         4 | 3619121402769 |          -1 |    0 | 00:06:52 | 2019-12-09 15:16:07 | 00:00:00     | 2019-12-09 15:16:07 | 00:00:00 | 2019-12-09 15:16:07 |     0 |      0
  21 |          -2 |          0 |        0 |           |            -1 |          -1 |   -1 | 01:03:52 | 1969-12-31 23:59:59 | 01:31:44     | 1969-12-31 23:59:59 | 00:00:00 | 1970-01-01 02:35:36 |     0 |      0
(21 rows)

ROLLBACK;
ROLLBACK
