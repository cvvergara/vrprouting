BEGIN;
BEGIN
SET client_min_messages TO NOTICE;
SET
SET search_path TO 'example2', 'public';
SET
UPDATE vehicles
    SET stops = NULL;
UPDATE 180
SELECT id
FROM shipments
WHERE '2019-12-09 14:00:00' <= p_tw_open AND d_tw_close <= '2019-12-09 15:55:00'
ORDER BY id;
 id
-----
  20
  50
  67
  93
  97
 105
 205
 219
 229
 406
 407
 425
 429
 432
 472
 476
 503
 505
 506
 507
 508
(21 rows)

SELECT id, stops
FROM vehicles
WHERE id IN (585);
 id  | stops
-----+-------
 585 |
(1 row)

SELECT *
FROM vrp_pickDeliverAddRaw(
    $$SELECT id, amount, p_id, p_open, p_close, p_service, d_id, d_open, d_close, d_service FROM shipments$$::TEXT,
    $$SELECT id, capacity, stops, s_id, s_open, s_close, s_service, e_id, e_open, e_close, e_service FROM vehicles WHERE id = 585$$::TEXT,
    $$SELECT start_vid, end_vid, agg_cost FROM timeMatrix$$::TEXT,
    $$SELECT * FROM tdm_raw('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
    507, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | order_id | cargo | travel_fd | arrival_ft | wait_fd | schedule_ft | service_fd | departure_ft | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+----------+-------+-----------+------------+---------+-------------+------------+--------------+-------+--------
   1 |           1 |         -1 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 |          0 |       0 |           0 |          0 |            0 |     0 |      0
   2 |           1 |         -1 |        2 |         6 | 3619121402769 |       -1 |     0 |         0 |          0 |       0 |           0 |          0 |            0 |     0 |      0
   3 |           2 |        585 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 | 1575900000 |       0 |  1575900000 |          0 |   1575900000 |     0 |      0
   4 |           2 |        585 |        2 |         2 | 3618671402855 |      507 |     1 |       261 | 1575900261 |       0 |  1575900261 |          0 |   1575900261 |     0 |      0
   5 |           2 |        585 |        3 |         3 | 3619091402880 |      507 |     0 |       199 | 1575900460 |       0 |  1575900460 |          0 |   1575900460 |     0 |      0
   6 |           2 |        585 |        4 |         6 | 3619121402769 |       -1 |     0 |       316 | 1575900776 |       0 |  1575900776 |          0 |   1575900776 |     0 |      0
   7 |          -2 |          0 |        0 |        -1 |            -1 |       -1 |    -1 |       776 |         -1 |       0 |          -1 |          0 |          776 |     0 |      0
(7 rows)

UPDATE vehicles SET stops = ARRAY[507, 507]
WHERE id = 585;
UPDATE 1
SELECT *
FROM vrp_pickDeliverAddRaw(
    $$SELECT id, amount, p_id, p_open, p_close, p_service, d_id, d_open, d_close, d_service FROM shipments$$::TEXT,
    $$SELECT id, capacity, stops, s_id, s_open, s_close, s_service, e_id, e_open, e_close, e_service FROM vehicles WHERE id = 585$$::TEXT,
    $$SELECT start_vid, end_vid, agg_cost FROM timeMatrix$$::TEXT,
    $$SELECT * FROM tdm_raw('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
    205, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | order_id | cargo | travel_fd | arrival_ft | wait_fd | schedule_ft | service_fd | departure_ft | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+----------+-------+-----------+------------+---------+-------------+------------+--------------+-------+--------
   1 |           1 |         -1 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 |          0 |       0 |           0 |          0 |            0 |     0 |      0
   2 |           1 |         -1 |        2 |         6 | 3619121402769 |       -1 |     0 |         0 |          0 |       0 |           0 |          0 |            0 |     0 |      0
   3 |           2 |        585 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 | 1575900000 |       0 |  1575900000 |          0 |   1575900000 |     0 |      0
   4 |           2 |        585 |        2 |         2 | 3618671402855 |      507 |     1 |       261 | 1575900261 |       0 |  1575900261 |          0 |   1575900261 |     0 |      0
   5 |           2 |        585 |        3 |         3 | 3619091402880 |      507 |     0 |       199 | 1575900460 |       0 |  1575900460 |          0 |   1575900460 |     0 |      0
   6 |           2 |        585 |        4 |         2 | 3620261402709 |      205 |     1 |       537 | 1575900997 |    2603 |  1575903600 |          0 |   1575903600 |     0 |      0
   7 |           2 |        585 |        5 |         3 | 3620351402932 |      205 |     0 |       555 | 1575904155 |       0 |  1575904155 |          0 |   1575904155 |     0 |      0
   8 |           2 |        585 |        6 |         6 | 3619121402769 |       -1 |     0 |       412 | 1575904567 |       0 |  1575904567 |          0 |   1575904567 |     0 |      0
   9 |          -2 |          0 |        0 |        -1 |            -1 |       -1 |    -1 |      1964 |         -1 |    2603 |          -1 |          0 |         4567 |     0 |      0
(9 rows)

UPDATE vehicles SET stops = ARRAY[507, 507, 205, 205]
WHERE id = 585;
UPDATE 1
SELECT *
FROM vrp_pickDeliverAddRaw(
    $$SELECT id, amount, p_id, p_open, p_close, p_service, d_id, d_open, d_close, d_service FROM shipments$$::TEXT,
    $$SELECT id, capacity, stops, s_id, s_open, s_close, s_service, e_id, e_open, e_close, e_service FROM vehicles WHERE id = 585$$::TEXT,
    $$SELECT start_vid, end_vid, agg_cost FROM timeMatrix$$::TEXT,
    $$SELECT * FROM tdm_raw('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
    508, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | order_id | cargo | travel_fd | arrival_ft | wait_fd | schedule_ft | service_fd | departure_ft | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+----------+-------+-----------+------------+---------+-------------+------------+--------------+-------+--------
   1 |           1 |         -1 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 |          0 |       0 |           0 |          0 |            0 |     0 |      0
   2 |           1 |         -1 |        2 |         6 | 3619121402769 |       -1 |     0 |         0 |          0 |       0 |           0 |          0 |            0 |     0 |      0
   3 |           2 |        585 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 | 1575900000 |       0 |  1575900000 |          0 |   1575900000 |     0 |      0
   4 |           2 |        585 |        2 |         2 | 3618671402855 |      507 |     1 |       261 | 1575900261 |       0 |  1575900261 |          0 |   1575900261 |     0 |      0
   5 |           2 |        585 |        3 |         2 | 3618791402920 |      508 |     2 |       151 | 1575900412 |       0 |  1575900412 |          0 |   1575900412 |     0 |      0
   6 |           2 |        585 |        4 |         3 | 3619091402880 |      507 |     1 |       186 | 1575900598 |       0 |  1575900598 |          0 |   1575900598 |     0 |      0
   7 |           2 |        585 |        5 |         3 | 3619401402840 |      508 |     0 |       198 | 1575900796 |       0 |  1575900796 |          0 |   1575900796 |     0 |      0
   8 |           2 |        585 |        6 |         2 | 3620261402709 |      205 |     1 |       458 | 1575901254 |    2346 |  1575903600 |          0 |   1575903600 |     0 |      0
   9 |           2 |        585 |        7 |         3 | 3620351402932 |      205 |     0 |       555 | 1575904155 |       0 |  1575904155 |          0 |   1575904155 |     0 |      0
  10 |           2 |        585 |        8 |         6 | 3619121402769 |       -1 |     0 |       412 | 1575904567 |       0 |  1575904567 |          0 |   1575904567 |     0 |      0
  11 |          -2 |          0 |        0 |        -1 |            -1 |       -1 |    -1 |      2221 |         -1 |    2346 |          -1 |          0 |         4567 |     0 |      0
(11 rows)

UPDATE vehicles SET stops = ARRAY[507, 508, 507, 508, 205, 205]
WHERE id = 585;
UPDATE 1
SELECT *
FROM vrp_pickDeliverAddRaw(
    $$SELECT id, amount, p_id, p_open, p_close, p_service, d_id, d_open, d_close, d_service FROM shipments$$::TEXT,
    $$SELECT id, capacity, stops, s_id, s_open, s_close, s_service, e_id, e_open, e_close, e_service FROM vehicles WHERE id = 585$$::TEXT,
    $$SELECT start_vid, end_vid, agg_cost FROM timeMatrix$$::TEXT,
    $$SELECT * FROM tdm_raw('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
    20, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | order_id | cargo | travel_fd | arrival_ft |  wait_fd   | schedule_ft | service_fd | departure_ft | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+----------+-------+-----------+------------+------------+-------------+------------+--------------+-------+--------
   1 |           1 |        585 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 | 1575900000 |          0 |  1575900000 |          0 |   1575900000 |     0 |      0
   2 |           1 |        585 |        2 |         2 | 3618671402855 |      507 |     1 |       261 | 1575900261 |          0 |  1575900261 |          0 |   1575900261 |     0 |      0
   3 |           1 |        585 |        3 |         2 | 3618791402920 |      508 |     2 |       151 | 1575900412 |          0 |  1575900412 |          0 |   1575900412 |     0 |      0
   4 |           1 |        585 |        4 |         3 | 3619091402880 |      507 |     1 |       186 | 1575900598 |          0 |  1575900598 |          0 |   1575900598 |     0 |      0
   5 |           1 |        585 |        5 |         3 | 3619401402840 |      508 |     0 |       198 | 1575900796 |          0 |  1575900796 |          0 |   1575900796 |     0 |      0
   6 |           1 |        585 |        6 |         2 | 3620261402709 |      205 |     1 |       458 | 1575901254 |       2346 |  1575903600 |          0 |   1575903600 |     0 |      0
   7 |           1 |        585 |        7 |         3 | 3620351402932 |      205 |     0 |       555 | 1575904155 |          0 |  1575904155 |          0 |   1575904155 |     0 |      0
   8 |           1 |        585 |        8 |         6 | 3619121402769 |       -1 |     0 |       412 | 1575904567 |          0 |  1575904567 |          0 |   1575904567 |     0 |      0
   9 |           2 |         -1 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 |          0 | 1575902391 |           0 |          0 |   1575902391 |     0 |      0
  10 |           2 |         -1 |        2 |         2 | 3627141402002 |       20 |     1 |      1209 | 1575903600 |          0 |  1575903600 |          0 |   1575903600 |     0 |      0
  11 |           2 |         -1 |        3 |         3 | 3629411402032 |       20 |     0 |       472 | 1575904072 |          0 |  1575904072 |          0 |   1575904072 |     0 |      0
  12 |           2 |         -1 |        4 |         6 | 3619121402769 |       -1 |     0 |      1623 | 1575905695 |          0 |  1575905695 |          0 |   1575905695 |     0 |      0
  13 |          -2 |          0 |        0 |        -1 |            -1 |       -1 |    -1 |      2221 |         -1 |       2346 |          -1 |          0 |         4567 |     0 |      0
(13 rows)

SELECT *
FROM vrp_pickDeliverAddRaw(
    $$SELECT id, amount, p_id, p_open, p_close, p_service, d_id, d_open, d_close, d_service FROM shipments$$::TEXT,
    $$SELECT id, capacity, stops, s_id, s_open, s_close, s_service, e_id, e_open, e_close, e_service FROM vehicles$$::TEXT,
    $$SELECT start_vid, end_vid, agg_cost FROM timeMatrix$$::TEXT,
    $$SELECT * FROM tdm_raw('2019-12-09'::TIMESTAMP, '2019-12-13'::TIMESTAMP)$$::TEXT,
    20, factor => 1.0::float);
 seq | vehicle_seq | vehicle_id | stop_seq | stop_type |    stop_id    | order_id | cargo | travel_fd | arrival_ft | wait_fd | schedule_ft | service_fd | departure_ft | cvtot | twvtot
-----+-------------+------------+----------+-----------+---------------+----------+-------+-----------+------------+---------+-------------+------------+--------------+-------+--------
   1 |           1 |         -1 |        1 |         1 | 3624551401919 |       -1 |     0 |         0 |          0 |       0 |           0 |          0 |            0 |     0 |      0
   2 |           1 |         -1 |        2 |         6 | 3624551401919 |       -1 |     0 |         0 |          0 |       0 |           0 |          0 |            0 |     0 |      0
   3 |           2 |        589 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 | 1575899400 |       0 |  1575899400 |          0 |   1575899400 |     0 |      0
   4 |           2 |        589 |        2 |         6 | 3619121402769 |       -1 |     0 |         0 | 1575899400 |       0 |  1575899400 |          0 |   1575899400 |     0 |      0
   5 |           3 |        597 |        1 |         1 | 3624551401919 |       -1 |     0 |         0 | 1575900000 |    3158 |  1575900000 |          0 |   1575903158 |     0 |      0
   6 |           3 |        597 |        2 |         2 | 3627141402002 |       20 |     1 |       442 | 1575903600 |       0 |  1575903600 |          0 |   1575903600 |     0 |      0
   7 |           3 |        597 |        3 |         3 | 3629411402032 |       20 |     0 |       472 | 1575904072 |       0 |  1575904072 |          0 |   1575904072 |     0 |      0
   8 |           3 |        597 |        4 |         6 | 3624551401919 |       -1 |     0 |       697 | 1575904769 |       0 |  1575904769 |          0 |   1575904769 |     0 |      0
   9 |           4 |        601 |        1 |         1 | 3624551401919 |       -1 |     0 |         0 | 1575896400 |       0 |  1575896400 |          0 |   1575896400 |     0 |      0
  10 |           4 |        601 |        2 |         6 | 3624551401919 |       -1 |     0 |         0 | 1575896400 |       0 |  1575896400 |          0 |   1575896400 |     0 |      0
  11 |           5 |        605 |        1 |         1 | 3624551401919 |       -1 |     0 |         0 | 1575900000 |       0 |  1575900000 |          0 |   1575900000 |     0 |      0
  12 |           5 |        605 |        2 |         6 | 3624551401919 |       -1 |     0 |         0 | 1575900000 |       0 |  1575900000 |          0 |   1575900000 |     0 |      0
  13 |           6 |        585 |        1 |         1 | 3619121402769 |       -1 |     0 |         0 | 1575900000 |       0 |  1575900000 |          0 |   1575900000 |     0 |      0
  14 |           6 |        585 |        2 |         2 | 3618671402855 |      507 |     1 |       261 | 1575900261 |       0 |  1575900261 |          0 |   1575900261 |     0 |      0
  15 |           6 |        585 |        3 |         2 | 3618791402920 |      508 |     2 |       151 | 1575900412 |       0 |  1575900412 |          0 |   1575900412 |     0 |      0
  16 |           6 |        585 |        4 |         3 | 3619091402880 |      507 |     1 |       186 | 1575900598 |       0 |  1575900598 |          0 |   1575900598 |     0 |      0
  17 |           6 |        585 |        5 |         3 | 3619401402840 |      508 |     0 |       198 | 1575900796 |       0 |  1575900796 |          0 |   1575900796 |     0 |      0
  18 |           6 |        585 |        6 |         2 | 3620261402709 |      205 |     1 |       458 | 1575901254 |    2346 |  1575903600 |          0 |   1575903600 |     0 |      0
  19 |           6 |        585 |        7 |         3 | 3620351402932 |      205 |     0 |       555 | 1575904155 |       0 |  1575904155 |          0 |   1575904155 |     0 |      0
  20 |           6 |        585 |        8 |         6 | 3619121402769 |       -1 |     0 |       412 | 1575904567 |       0 |  1575904567 |          0 |   1575904567 |     0 |      0
  21 |          -2 |          0 |        0 |        -1 |            -1 |       -1 |    -1 |      3832 |         -1 |    5504 |          -1 |          0 |         9336 |     0 |      0
(21 rows)

ROLLBACK;
ROLLBACK
